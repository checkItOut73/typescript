import webpackHotMiddleware from 'webpack-hot-middleware';

const HOT_MODULE_REPLACEMENT_ROUTE = '/__webpack_hmr';
const FLUSH_TIMEOUT = 2000;
const FLUSH_STRING =
    '################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################';

export default function webpackHotMiddlewareFlushProxy(webpackCompiler) {
    const hotMiddleware = webpackHotMiddleware(webpackCompiler, {
        path: HOT_MODULE_REPLACEMENT_ROUTE
    });

    return (request, response, next) => {
        if (request.url === HOT_MODULE_REPLACEMENT_ROUTE) {
            setTimeout(() => {
                response.write(
                    'data: ' +
                        JSON.stringify({
                            flush: FLUSH_STRING
                        }) +
                        '\n\n'
                );
            }, FLUSH_TIMEOUT);
        }

        return hotMiddleware(request, response, next);
    };
}
